API
Документ описывает REST API бэкенд-сервиса и контракты взаимодействия с OpenWebUI.
Принципы
1. Base URL: /api/v1
2. Format: JSON
3. Auth: Bearer Token (JWT), прокидываемый из OpenWebUI.
4. Errors: Стандартный формат { "detail": "Error message", "code": "ERROR_CODE" }
Интеграция с OpenWebUI
OpenWebUI в данном проекте используется как тонкий клиент поверх backend API. В нем не содержится собственной LLM, принимающей решения о вызове backend API. LLM OpenWebUI выбирает самостоятельно тип действия (ingest, обновление, поиск и т.п.) Все вызовы backend API (POST /ingest, GET/PATCH /drafts/{id}, POST /search/analogs, POST /drafts/{id}/commit) выполняются напрямую из фронтенда, по действиям пользователя (кнопки, формы, UI-ивенты).
Эндпоинты
Ingestion
Единый ingestion-эндпоинт отвечает за создание черновика и запуск асинхронного пайплайна обработки (парсинг, нормализация, классификация, поиск аналогов). Актуальное состояние черновика (включая extracted_data, final_data, predictions, erp_ref_key) и все извлеченные данные всегда читаются через GET /drafts/{id}. Эндпоинт предназначен только для инициации обработки.
POST /ingest
Создаёт черновик карточки товара и запускает асинхронный пайплайн обработки (парсинг → нормализация → классификация → поиск аналогов).


Request


Content-Type зависит от типа источника: в случае если источником является ссылка или текст, Content-Type: application/json, а если передается файл, то Content-Type: multipart/form-data.


Параметры запроса


Поле
	Тип
	Обязательное
	Описание
	source_type
	string
	да
	Тип источника данных: url, text или file
	url
	string
	да, если source_type = "url"
	URL веб-страницы с описанием товара
	text
	string
	да, если source_type = "text"
	Сырой текст с описанием товара
	file
	file (binary)
	да, если source_type = "file"
	Бинарное содержимое загружаемого файла
	

Ограничения


* Должен быть указан source_type и ровно один из полей-источников (url, text или file).
* При некорректной комбинации полей или отсутствии обязательных данных возвращается ошибка 400 Bad Request.


Response (200 OK)


{
  "draft_id": "uuid",
  "status": "new",
  "source_type": "url",
  "source_payload": "https://market.ru/product/123"
}


Поля ответа


Поле
	Тип
	Описание
	draft_id
	string (uuid)
	Идентификатор созданного черновика (app.draft_cards)
	status
	string
	Текущий статус черновика (new, processing, ready_for_review, synced, error)
	source_type
	string
	Тип источника данных: url, text или file
	source_payload
	string
	Исходные данные источника: URL, текстовый preview или имя файла
	

Замечания к source_payload:


* Для source_type = "url" содержит исходный URL.
* Для source_type = "text" может содержать усечённый preview исходного текста. todo
* Для source_type = "file" содержит имя файла в том виде, как его прислал клиент (например, order_item_1245.docx). Внутренняя ссылка на файл в объектном хранилище (storage_uri) хранится только во внутренней таблице app.draft_sources и во внешнем API не раскрывается.
* 

Важно: даже если сервис вернул в ответе дополнительные поля (например, мгновенно рассчитанный draft или диагностику), единственным источником правды о состоянии черновика все равно считается GET /drafts/{id}


Ошибки


Код
	Условие
	400 Bad Request
	Некорректная комбинация полей запроса или отсутствуют обязательные данные для выбранного source_type
	413 Payload Too Large
	Размер файла превышает допустимый лимит
	415 Unsupported Media Type
	Неподдерживаемый формат файла или некорректный Content-Type
	500 Internal Server Error
	Внутренняя ошибка сервиса при создании черновика
	

Поведение статусов при ошибках Docling/LLM:


* Успешная обработка файла: черновик после завершения пайплайна переходит в статус ready_for_review (Docling и LLM отработали успешно, поля extracted_data / final_data заполнены).
* Ошибка Docling или LLM: HTTP‑ответ POST /ingest остаётся 200 OK, но у черновика выставляется статус error, а текст ошибки сохраняется во внутреннем поле sync_error. Клиент должен проверять поле status через GET /drafts/{id} и отображать пользователю, что автоматическое заполнение недоступно.
* 500 Internal Server Error зарезервирован для инфраструктурных сбоев (ошибка сервера, недоступность БД/инфраструктуры) и не используется для «ожидаемых» ошибок пайплайна Docling/LLM.


Важно: ответ POST /ingest не содержит DraftCard.
Единственным источником правды о состоянии карточки является GET /drafts/{id}.
Draft Management (Управление черновиками)
GET /drafts/{id}
Получает текущее состояние черновика.


Request


Без тела запроса; идентификатор черновика передаётся в пути ({id} — UUID).


Response (200 OK)


Тело ответа соответствует модели DraftCard.


Поля ответа


См. описание модели DraftCard ниже.


Ошибки


Код
	Условие
	400 Bad Request
	Некорректный формат идентификатора id
	404 Not Found
	Черновик с указанным id не найден или недоступен
	PATCH /drafts/{id}
Обновляет поля черновика. Вызывается при редактировании пользователем.


Request


{
  "final_data": {
    "weight": 1.5,
    "brand": "New Brand"
  }
}


Тело запроса соответствует частичной модели final_data, реализуется как PATCH только переданных полей.


Response (200 OK)


{
  "draft": DraftCard
}


Поля ответа


Поле
	Тип
	Описание
	draft
	DraftCard
	Обновлённое состояние черновика целиком
	

Ошибки


Код
	Условие
	400 Bad Request
	Некорректное тело запроса или формат id
	404 Not Found
	Черновик с указанным id не найден или недоступен
	

Поведение при обновлении черновика:


* PATCH /drafts/{id} с изменениями в final_data может триггерить пересчёт predictions.gau, если изменились поля, влияющие на классификацию (вид, тип, характеристики и т.п.);
* после значимых изменений в final_data предыдущие результаты поиска аналогов считаются устаревшими: реализация может, например, сбросить predictions.duplicates.count и/или predictions.duplicates.last_checked_at, побуждая клиента выполнить новый POST /search/analogs для актуализации аналогов.
POST /drafts/{id}/generate-name
Перегенерирует название товара на основе текущих полей черновика.


Cервер может автоматически генерировать final_data.generated_name при создании/обновлении черновика, пока пользователь сам не задал это поле через PATCH /drafts/{id} Если пользователь прислал generated_name в final_data через PATCH, это значение считается ручным override и больше не перегенерируется автоматически;
Явный вызов POST /drafts/{id}/generate-name всегда перезаписывает final_data.generated_name новым значением, независимо от того, было ли оно выставлено автоматически или вручную.


Request


Пустое тело запроса; идентификатор черновика передаётся в пути ({id}).


Response (200 OK)


{
  "generated_name": "Ручка шариковая 0.5мм синяя Pilot G2"
}


Поля ответа


Поле
	Тип
	Описание
	generated_name
	string
	Новое сгенерированное стандартизированное наименование товара
	

Ошибки


Код
	Условие
	404 Not Found
	Черновик с указанным id не найден или недоступен
	POST /drafts/{id}/commit
Переводит черновик в состояние "готов к синхронизации" с 1С. Фактическое создание номенклатуры в 1С выполняется асинхронным процессом (ETL/worker) и отражается в полях status и erp_ref_key сущности DraftCard.


Request


Пустое тело запроса. Идентификатор черновика передаётся в пути ({id}).


После вызова этого метода клиент должен периодически вызывать GET /drafts/{id} и отслеживать смену status на synced и появление erp_ref_key.


Response (200 OK)


{
  "status": "ready_to_sync"
}


Поля ответа


Поле
	Тип
	Описание
	status
	string
	Новый статус черновика (обычно ready_to_sync)
	

Ошибки


Код
	Условие
	404 Not Found
	Черновик с указанным id не найден или недоступен
	409 Conflict
	Черновик находится в неподходящем статусе
	Search & Lookup (Поиск)
POST /search/analogs
Поиск дубликатов и аналогов товаров по данным черновика и/или текстовому запросу.


Request


{
  "query": "Мышь logitech",
  "draft_id": "uuid"
}


Поддерживает три режима работы:


* поиск по черновику;
* поиск по тексту;
* поиск по черновику с дополнительным текстовым уточнением.


Поле
	Тип
	Обязательное
	Описание
	draft_id
	string (uuid)
	нет
	Идентификатор черновика, для которого требуется найти аналоги
	query
	string
	нет
	Произвольный текстовый поисковый запрос
	

Ограничения:


* должно быть передано хотя бы одно из полей (draft_id или query);
* если не передано ни одно — возвращается ошибка 400 Bad Request.


Response (200 OK)


{
  "results": [
    {
      "ref_key": "string",
      "name": "string",
      "score": 0.98
    }
  ]
}


Поля ответа


Поле
	Тип
	Описание
	ref_key
	string
	Идентификатор товара в 1C
	name
	string
	Наименование товара
	score
	number (0.0 – 1.0)
	Скор сходства
	

Ошибки


Код
	Условие
	400 Bad Request
	Одновременно не переданы draft_id и query
	404 Not Found
	draft_id не существует или недоступен пользователю
	500 Internal Server Error
	Ошибка поиска или пайплайна
	Data Models (Схемы данных)
DraftCard
Примечание по статусам new и processing:


* new — черновик только что создан и ещё не взят в обработку воркерами/пайплайном;
* processing — черновик уже обрабатывается (парсинг, нормализация, классификация, поиск аналогов).


В пользовательском интерфейсе эти состояния могут отображаться единым статусом «идёт обработка», так как различие между ними в основном техническое и важно для операционного мониторинга (например, диагностики проблем с очередью задач).


{
  "id": "uuid",
  "status": "new" | "processing" | "ready_for_review" | "synced" | "error",
  "extracted_data": { ... },             // Данные от LLM
  "final_data": {                        // Данные для 1С
    "kind": "string",
    "type": "string",
    "brand": "string",
    "article": "string",
    "specs": {},
    "generated_name": "string",         // Стандартизированное краткое наименование товара для UI (основной заголовок карточки)
    "description": "string",            // Расширенное текстовое описание товара
    "images": []
  },
  "predictions": {
    "gau": { "code": "001", "confidence": 0.95 },
    "duplicates": {
      "count": 3,                      // Количество найденных дублей/аналогов по результатам последнего выполненного поиска
      "last_checked_at": "2025-01-01T12:34:56Z" // Момент времени последней проверки аналогов (ISO8601); UI может использовать для оценки актуальности данных
    }
  },
  "erp_ref_key": "string | null"
}
Статусы черновика и допустимые операции
Статус
	Описание
	Методы, которые можно вызывать
	new
	Черновик создан, пайплайн ещё не стартовал
	GET /drafts/{id}, PATCH /drafts/{id}, POST /drafts/{id}/generate-name, POST /search/analogs (по draft_id или query)
	processing
	Черновик в обработке (парсинг, нормализация, поиск аналогов)
	GET /drafts/{id}, PATCH /drafts/{id}, POST /drafts/{id}/generate-name, POST /search/analogs
	ready_for_review
	Пайплайн завершён, данные готовы к ручной проверке пользователем
	GET /drafts/{id}, PATCH /drafts/{id}, POST /drafts/{id}/generate-name, POST /search/analogs, POST /drafts/{id}/commit
	synced
	Черновик синхронизирован с 1С, создана финальная номенклатура
	GET /drafts/{id}; PATCH /drafts/{id} и POST /drafts/{id}/commit обычно запрещены (должен возвращаться 409 Conflict, если политика не позволяет правки после синка)
	error
	Ошибка пайплайна
	GET /drafts/{id}, PATCH /drafts/{id}, POST /drafts/{id}/generate-name, POST /search/analogs, пока статус не сменён на ready_for_review
	

Поведение клиента:


* для статусов new и processing фронтенд регулярно опрашивает GET /drafts/{id} и отображает единый пользовательский статус «идёт обработка»;
* редактирование (PATCH /drafts/{id}) и повторная генерация названия (POST /drafts/{id}/generate-name) допускаются во всех статусах, кроме synced (по умолчанию);
* попытка выполнить POST /drafts/{id}/commit в статусах, отличных от ready_for_review, должна приводить к 409 Conflict с кодом ошибки.